version: 2.1

jobs:
  build-and-upload-lambdas:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Install dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y awscli zip python3-pip

      - run:
          name: Build & upload all lambdas
          command: |
            BUCKET="terra-lambdas"

            for dir in lambdas/*; do
              if [ -d "$dir" ]; then
                LAMBDA_NAME=$(basename "$dir")
                echo "ðŸš€ Processing $LAMBDA_NAME"

                cd "$dir"

                # Node.js lambda
                if [ -f package.json ]; then
                  echo "Detected Node.js lambda"
                  npm install --production
                fi

                # Python lambda
                if [ -f requirements.txt ]; then
                  echo "Detected Python lambda"
                  pip3 install -r requirements.txt -t .
                fi

                ZIP_NAME="${LAMBDA_NAME}.zip"
                zip -r "$ZIP_NAME" .

                aws s3 cp "$ZIP_NAME" "s3://$BUCKET/$ZIP_NAME"

                cd - >/dev/null
              fi
            done

workflows:
  build-and-upload-lambdas:
    jobs:
      - build-and-upload-lambdas
