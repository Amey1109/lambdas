version: 2.1

jobs:
  build-zip-upload:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Install system dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y \
              zip \
              python3 \
              python3-pip \
              awscli

      - run:
          name: Build, zip & upload lambdas
          command: |
            set -e

            BUCKET="terra-lambdas"

            for dir in */; do
              dirname=${dir%/}

              # Skip hidden/system folders
              if [[ "$dirname" == ".circleci" || "$dirname" == ".git" ]]; then
                continue
              fi

              echo "ðŸš€ Processing: $dirname"

              cd "$dirname"

              # Node.js lambda
              if [ -f package.json ]; then
                echo "ðŸ“¦ Node.js detected"
                npm install --production
              fi

              # Python lambda
              if [ -f requirements.txt ]; then
                echo "ðŸ Python detected"
                pip3 install -r requirements.txt -t .
              fi

              ZIP_PATH="../${dirname}.zip"
              echo "ðŸ—œ Zipping contents to $ZIP_PATH"
              zip -rq "$ZIP_PATH" .

              echo "â˜ï¸ Uploading ${dirname}.zip to S3"
              aws s3 cp "$ZIP_PATH" "s3://$BUCKET/${dirname}.zip"

              cd - >/dev/null
            done

            echo "âœ… All folders zipped and uploaded"

      - run:
          name: Trigger Terraform pipeline
          command: |
            curl -X POST https://circleci.com/api/v2/project/github/Amey1109/terra-lambdas/pipeline \
              -H "Circle-Token: $CIRCLECI_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{ "branch": "main" }'

workflows:
  build-zip-upload-workflow:
    jobs:
      - build-zip-upload
