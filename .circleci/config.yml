version: 2.1

jobs:
  aws-smoke-test:
    docker:
      - image: cimg/base:stable

    steps:
      - checkout

      - run:
          name: Install AWS CLI
          command: |
            sudo apt-get update
            sudo apt-get install -y awscli

      - run:
          name: Verify AWS identity
          command: |
            aws sts get-caller-identity

      - run:
          name: Test S3 access
          command: |
            aws s3 ls s3://terra-lambdas

      - run:
          name: Test S3 upload (safe)
          command: |
            echo "circleci-smoke-test" > test.txt
            aws s3 cp test.txt s3://terra-lambdas/circleci-smoke-test.txt
            aws s3 rm s3://terra-lambdas/circleci-smoke-test.txt

workflows:
  aws-smoke-test-workflow:
    jobs:
      - aws-smoke-test
