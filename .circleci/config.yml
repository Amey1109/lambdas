version: 2.1

jobs:
  build-zips:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Install build dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y zip python3 python3-pip

      - run:
          name: Build & zip lambdas
          command: |
            set -euo pipefail
            mkdir -p zips

            for dir in */; do
              name=${dir%/}

              if [[ "$name" == ".circleci" || "$name" == ".git" ]]; then
                continue
              fi

              echo "üöÄ Zipping $name"
              cd "$name"

              if [ -f package.json ]; then
                npm install --production
              fi

              if [ -f requirements.txt ]; then
                pip3 install -r requirements.txt -t .
              fi

              zip -rq "../zips/${name}.zip" .
              cd - >/dev/null
            done

      - persist_to_workspace:
          root: .
          paths:
            - zips

  upload-zips:
    docker:
      - image: cimg/base:stable
    working_directory: ~/repo

    steps:
      - attach_workspace:
          at: .

      - run:
          name: Install AWS CLI
          command: |
            sudo apt-get update
            sudo apt-get install -y awscli

      - run:
          name: Upload zips to S3
          command: |
            set -euo pipefail
            BUCKET="terra-lambdas"
            COUNT=0

            for zip in zips/*.zip; do
              [ -e "$zip" ] || exit 1
              echo "‚òÅÔ∏è Uploading $zip"
              aws s3 cp "$zip" "s3://$BUCKET/$(basename "$zip")"
              COUNT=$((COUNT + 1))
            done

            echo "‚úÖ Uploaded $COUNT zip(s)"

  trigger-terraform:
    docker:
      - image: cimg/base:stable

    steps:
      - run:
          name: Trigger Terraform pipeline
          command: |
            curl -f -X POST https://circleci.com/api/v2/project/github/Amey1109/terra-lambdas/pipeline \
              -H "Circle-Token: $CIRCLECI_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{ "branch": "main" }'

workflows:
  lambda-deploy:
    jobs:
      - build-zips
      - upload-zips:
          requires:
            - build-zips
      - trigger-terraform:
          requires:
            - upload-zips
