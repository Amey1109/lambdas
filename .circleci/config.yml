version: 2.1

jobs:
  build-zips:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Install build dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y zip python3 python3-pip

      - run:
          name: Build Lambda zips
          command: |
            set -euo pipefail
            mkdir -p zips/lambdas

            for dir in lambdas/*/; do
              name=$(basename "$dir")
              echo "üöÄ Building lambda: $name"

              cd "$dir"
              zip -rq "../../zips/lambdas/${name}.zip" .
              cd - >/dev/null
            done

      - run:
          name: Build Layer zips
          command: |
            set -euo pipefail
            mkdir -p zips/layers

            for layer in layers/*/; do
              layer_name=$(basename "$layer")
              zip_name="${layer_name}-layer.zip"

              echo "üì¶ Building layer: $zip_name"

              cd "$layer"

              if [ ! -d nodejs ]; then
                echo "‚ùå Layer $layer_name missing nodejs/ directory"
                exit 1
              fi

              cd nodejs

              if [ -f package.json ]; then
                npm ci --omit=dev
              fi

              cd ..
              zip -rq "../../zips/layers/$zip_name" nodejs
              cd - >/dev/null
            done

      - persist_to_workspace:
          root: .
          paths:
            - zips

  upload-zips:
    docker:
      - image: cimg/base:stable
    working_directory: ~/repo

    steps:
      - attach_workspace:
          at: .

      - run:
          name: Install AWS CLI
          command: |
            sudo apt-get update
            sudo apt-get install -y awscli

      - run:
          name: Upload Lambda & Layer zips to S3
          command: |
            set -euo pipefail
            BUCKET="terra-lambdas"

            for type in lambdas layers; do
              for zip in zips/$type/*.zip; do
                echo "‚òÅÔ∏è Uploading $zip"
                aws s3 cp "$zip" "s3://$BUCKET/$type/$(basename "$zip")"
              done
            done

  trigger-terraform:
    docker:
      - image: cimg/base:stable

    steps:
      - run:
          name: Trigger Terraform pipeline
          command: |
            curl -X POST https://circleci.com/api/v2/project/github/Amey1109/terra-lambdas/pipeline \
              -H "Circle-Token: $CIRCLECI_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{ 
                "branch": "dev",
                "parameters": {
                  "run_from_lambda": true
                }
              }'

workflows:
  lambda-deploy:
    jobs:
      - build-zips
      - upload-zips:
          requires:
            - build-zips
      - trigger-terraform:
          requires:
            - upload-zips
