version: 2.1

jobs:
  build-zip-upload:
    docker:
      - image: cimg/node:20.11 # Node + npm
    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Install system dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y \
              zip \
              python3 \
              python3-pip \
              awscli

      - run:
          name: Build, zip & upload lambdas
          command: |
            set -e

            BUCKET="terra-lambdas"

            for dir in lambdas/*/; do
              dirname=$(basename "${dir%/}")

              echo "ðŸš€ Processing lambda: $dirname"

              cd "$dir"

              # Node.js lambda
              if [ -f package.json ]; then
                echo "ðŸ“¦ Detected Node.js â€” installing dependencies"
                npm install --production
              fi

              # Python lambda
              if [ -f requirements.txt ]; then
                echo "ðŸ Detected Python â€” installing dependencies"
                pip3 install -r requirements.txt -t .
              fi

              ZIP_PATH="../../${dirname}.zip"
              echo "ðŸ—œ Zipping contents into $ZIP_PATH"
              zip -rq "$ZIP_PATH" .

              echo "â˜ï¸ Uploading to s3://$BUCKET/${dirname}.zip"
              aws s3 cp "$ZIP_PATH" "s3://$BUCKET/${dirname}.zip"

              cd - >/dev/null
            done

            echo "âœ… All lambdas built and uploaded"

workflows:
  build-zip-upload-workflow:
    jobs:
      - build-zip-upload
